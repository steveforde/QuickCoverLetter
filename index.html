<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>QuickCoverLetter ‚Äì ‚Ç¨1.99 Cover Letter in 10 Seconds</title>
    <meta
      name="description"
      content="Instant, professional cover letters. No subscriptions. Pay once per letter, get your PDF. Works on any device."
    />

    <link rel="manifest" href="/manifest.json" />
    <link rel="icon" type="image/png" href="/icon.png" />
    <link rel="apple-touch-icon" href="/icon.png" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="default" />
    <meta name="theme-color" content="#0070f3" />

    <link rel="stylesheet" href="style.css" />

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <script>
      // ‚úÖ FIX 2: ADDED LOGGING BRIDGE TO XCODE
      function logToXcode(message) {
        console.log(message);
        if (window.webkit && window.webkit.messageHandlers && window.webkit.messageHandlers.log) {
          window.webkit.messageHandlers.log.postMessage(message);
        }
      }

      // 1. Function called by Swift/WKNavigationDelegate to ENABLE the button.
      window.enablePayButton = function (price) {
        const btn = document.getElementById("payButton");
        if (!btn) return;

        btn.disabled = false;
        btn.textContent = `Pay ${price} to Unlock a letter`;
        logToXcode("üí∞ Pay button enabled via Swift");
      };

      // 2. Success callback from Swift/StoreKit.
      window.handleIAPSuccess = function (email) {
        logToXcode("üéâ IAP SUCCESS for " + email);
        // Uses the key you defined (K.PRO = "qcl_isPro")
        sessionStorage.setItem("qcl_isPro", "true");

        // This updates the UI in your script.js
        if (typeof updateLockState === "function") {
          updateLockState();
        }
        showToast("Templates unlocked!", "success");
      };

      // Simple toast function
      function showToast(msg, type = "info") {
        const toast = document.getElementById("toast");
        if (!toast) return;
        toast.textContent = msg;
        toast.className = `toast ${type} show`;
        clearTimeout(toast._hide);
        toast._hide = setTimeout(() => toast.classList.remove("show"), 4000);
      }
    </script>
  </head>

  <body>
    <header class="hero">
      <div class="hero-content">
        <h1>QuickCoverLetter</h1>
        <p>Professional cover letters in <strong>10 seconds</strong>. Pay once. Done.</p>
      </div>
      <button id="themeToggle" class="theme-btn" aria-label="Toggle dark mode">Dark Mode</button>
    </header>

    <div id="toast" class="toast" role="alert" aria-live="assertive"></div>

    <main>
      <form id="form" class="form-box" novalidate>
        <label for="jobTitle">Job Title <span class="required">*</span></label>
        <input type="text" id="jobTitle" placeholder="e.g. Customer Service Advisor" required />

        <label for="companyName">Company Name <span class="required">*</span></label>
        <input type="text" id="companyName" placeholder="e.g. Fexco" required />

        <label for="userName">Your Name <span class="required">*</span></label>
        <input type="text" id="userName" placeholder="e.g. John Smith" required />

        <label for="userEmail">Your Email <span class="required">*</span></label>
        <input type="email" id="userEmail" placeholder="e.g. jsmith08@gmail.com" required />

        <button id="payButton" type="button" class="pay-btn">Pay ‚Ç¨1.99 to Unlock</button>
      </form>

      <section class="template-section" aria-labelledby="template-heading">
        <div class="template-buttons">
          <h2
            id="template-heading"
            style="
              grid-column: 1 / -1;
              text-align: center;
              margin: 0 0 20px 0;
              font-size: 1.4rem;
              font-weight: 700;
              background: linear-gradient(90deg, #0070f3, #3898ff);
              -webkit-background-clip: text;
              -webkit-text-fill-color: transparent;
              background-clip: text;
              line-height: 1.2;
            "
          >
            Choose Your Template
          </h2>

          <div class="template-option">
            <button
              class="template-btn"
              data-type="professional"
              aria-describedby="desc-professional"
            >
              Professional
            </button>
            <p id="desc-professional" class="template-desc">
              Clean and confident ‚Äî ideal for corporate, tech, or government roles.
            </p>
          </div>
          <div class="template-option">
            <button class="template-btn" data-type="formal" aria-describedby="desc-formal">
              Formal
            </button>
            <p id="desc-formal" class="template-desc">
              Traditional and respectful ‚Äî great for finance, senior, or legal positions.
            </p>
          </div>

          <div class="template-option">
            <button class="template-btn" data-type="friendly" aria-describedby="desc-friendly">
              Friendly
            </button>
            <p id="desc-friendly" class="template-desc">
              Warm and approachable ‚Äî suited to customer support or public-facing roles.
            </p>
          </div>

          <div class="template-option">
            <button class="template-btn" data-type="artistic" aria-describedby="desc-artistic">
              Artistic
            </button>
            <p id="desc-artistic" class="template-desc">
              Creative and expressive ‚Äî perfect for design, media, or marketing roles.
            </p>
          </div>

          <div class="template-option">
            <button class="template-btn" data-type="graduate" aria-describedby="desc-graduate">
              Graduate
            </button>
            <p id="desc-graduate" class="template-desc">
              Fresh and ambitious ‚Äî ideal for recent graduates and first-job applications.
            </p>
          </div>
        </div>
      </section>

      <section id="resultBox" class="result-box hidden">
        <label for="coverLetter" class="result-label">Your Cover Letter</label>
        <textarea id="coverLetter" rows="14" readonly></textarea>

        <div class="result-buttons">
          <button id="downloadBtn">Download PDF</button>
          <button id="copyBtn">Copy</button>
          <button id="clearBtn" class="secondary">Clear & Reset</button>
        </div>
      </section>
    </main>

    <script>
      window.__SUPABASE_URL = "https://ztrsuveqeftmgoeiwjgz.supabase.co";
      window.__SUPABASE_ANON_KEY =
        "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp0cnN1dmVxZWZ0bWdvZWl3amd6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjE2NzQ0MDYsImV4cCI6MjA3NzI1MDQwNn0.efQI0fEnz_2wyCF-mlb-JnZAHtI-6xhNH8S7tdFLGyo";
    </script>

    <script type="module" src="script.js"></script>

    <footer>
      <p>
        ¬© 2025 <strong>QuickCoverLetter</strong> ‚Äî Made in Ireland |
        <a href="support.html">Support</a> |
        <a href="privacy.html">Privacy</a>
      </p>
    </footer>

    <script>
      document.addEventListener("DOMContentLoaded", () => {
        logToXcode("üü¢ DOM Loaded - Initializing Override PDF Logic");

        const downloadBtn = document.getElementById("downloadBtn");

        if (!downloadBtn) {
          logToXcode("üî¥ Error: downloadBtn not found");
          return;
        }

        // We use .onclick to force our logic to be the primary handler
        // This prevents the 'broken' logic in script.js from running silently
        downloadBtn.onclick = function (e) {
          e.preventDefault();
          e.stopPropagation(); // Stop other scripts from interfering

          logToXcode("üü° Download Clicked (Override)");

          // 1. GET DATA
          const coverLetter = document.getElementById("coverLetter");
          const jobField = document.getElementById("jobTitle");
          const companyField = document.getElementById("companyName");

          const textVal = coverLetter ? coverLetter.value : "";

          if (!textVal) {
            alert("Cover letter is empty!");
            return;
          }

          // 2. CHECK LIBRARY
          if (!window.jspdf) {
            logToXcode("üî¥ FATAL: jsPDF library missing");
            alert("Error: PDF Library missing. Refresh page.");
            return;
          }

          try {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF("p", "mm", "a4");

            pdf.setFont("times", "normal");
            pdf.setFontSize(12);

            // 3. WRAP TEXT
            const margin = 20;
            const pageWidth = 210;
            const maxWidth = pageWidth - margin * 2;
            const lines = pdf.splitTextToSize(textVal, maxWidth);

            pdf.text(lines, margin, 20);

            // 4. FILENAME
            let job = jobField ? jobField.value : "Job";
            let comp = companyField ? companyField.value : "Company";
            let fileName = `CoverLetter_${job}_${comp}.pdf`.replace(/[^a-zA-Z0-9_.]/g, "");

            logToXcode("‚úÖ PDF Created: " + fileName);

            // 5. SEND TO IOS
            const pdfData = pdf.output("datauristring");

            if (
              window.webkit &&
              window.webkit.messageHandlers &&
              window.webkit.messageHandlers.downloadPDF
            ) {
              logToXcode("üöÄ Sending to Swift...");
              window.webkit.messageHandlers.downloadPDF.postMessage({
                fileName: fileName,
                fileData: pdfData,
              });
            } else {
              logToXcode("‚ö†Ô∏è Browser Download");
              pdf.save(fileName);
            }
          } catch (err) {
            logToXcode("‚ùå CRASH: " + err.message);
            alert("Error: " + err.message);
          }
        };
      });
    </script>
  </body>
</html>
